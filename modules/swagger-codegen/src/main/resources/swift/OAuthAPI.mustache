//
//  AuthAPI.swift
//  Created by David Solberg on 11/13/16.
//  Generated by Swagger
//

import Foundation

let NotificationNameTokenRefresh = "TokenRefreshed"

class AuthAPI {
    
    static let oauthURLString = "XXXXXXXXXXXXXXXXXXXXXX"
    static let url = URL(string: oauthURLString)!
    static private(set) var isRefreshingToken = false
    
    /// Creates and securely saves a token if one exists from the account. Check the result for success to determine whether a token was granted.
    static func authorizeAccount(account: Account, completion: @escaping (_ result: NetworkResult<Oauth_info>) -> Void) -> Bool {
        guard isRefreshingToken == false else {
            assertionFailure("Should not happen!")
            return false
        }
        isRefreshingToken = true
        let parameters: [String:Any] =
        [
            "grant_type":Network.OAuth.grant_type_password,
            "client_id":Network.OAuth.client_id,
            "client_secret":Network.OAuth.client_secret
        ]
        
        return NetworkRequestorWithResultType<Oauth_info>.init(method: "POST", URL: url, headers: Network.Header.json, parameters: parameters).sendWithResult { (result: NetworkResult<Oauth_info>) -> Void in
            processResult(result: result, completion: completion)
        }
    }
    

    /// Refreshes the existing token if there is one. If no token exists, returns false. Also check the completion block to see whether the refresh was successful.
    static func refreshToken(completion: @escaping (_ result: NetworkResult<Oauth_info>) -> Void) -> Bool {

        guard let refreshtoken = Token.refresh else { return false }
        guard isRefreshingToken == false else {
            assertionFailure("Should not happen!")
            return false
        }
        isRefreshingToken = true
        let parameters: [String:Any]  =
        [
            "grant_type":Network.OAuth.grant_type_refresh,
            "refresh_token":refreshtoken
        ]
        
        return NetworkRequestorWithResultType<Oauth_info>.init(method: "POST", URL: url, headers: Network.Header.json, parameters: parameters).sendWithResult { (result: NetworkResult<Oauth_info>) -> Void in
                processResult(result: result, completion: completion)
        }
    }
    
    // MARK: - Helpers
    static func processResult(result: NetworkResult<Oauth_info>, completion: (_ result: NetworkResult<Oauth_info>) -> Void) {
        // Store the token if found
        if case NetworkResult.success(let info) = result {
            if let accessToken = info?.access_token {
                Token.header = accessToken
            }
            if let refreshToken = info?.refresh_token {
                Token.refresh = refreshToken
            }
        }
        isRefreshingToken = false
        NotificationCenter.default.post(name: NSNotification.Name(rawValue: NotificationNameTokenRefresh), object: nil)
        completion(result)
    }
}